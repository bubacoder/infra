# SearXNG is a free internet metasearch engine which aggregates results from various search services and databases.
# Users are neither tracked nor profiled.
#
# https://github.com/searxng/searxng  
# https://github.com/searxng/searxng-docker
---
name: searxng
services:
  searxng-redis:
    container_name: searxng-redis
    image: docker.io/valkey/valkey:8-alpine
    command: valkey-server --save 30 1 --loglevel warning
    restart: unless-stopped
    # Named volume is needed to avoid "chown - Operation not permitted" error
    volumes:
      - searxng-valkey-data:/data
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - proxy

  searxng:
    container_name: searxng
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    volumes:
      - ${DOCKER_VOLUMES}/searxng:/etc/searxng
      - ./searxng/settings.yml:/etc/searxng/settings.yml
    environment:
      SEARXNG_BASE_URL: https://searxng.${MYDOMAIN}/
      # https://docs.searxng.org/admin/settings/settings_server.html
      SEARXNG_SECRET: ${SEARXNG_SECRET}
      # https://docs.searxng.org/admin/settings/settings_redis.html
      SEARXNG_REDIS_URL: "redis://searxng-redis:6379/0"
      UWSGI_WORKERS: ${SEARXNG_UWSGI_WORKERS:-4}
      UWSGI_THREADS: ${SEARXNG_UWSGI_THREADS:-4}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - proxy
    labels:
      traefik.enable: true
      traefik.http.routers.searxng.entrypoints: websecure
      traefik.http.routers.searxng.middlewares: https-local@file
      traefik.http.services.searxng.loadbalancer.server.port: 8080
      homepage.group: Tools
      homepage.name: SearXNG
      homepage.icon: searxng.png
      homepage.href: https://searxng.${MYDOMAIN}/
      homepage.description: "Internet metasearch engine"

networks:
  proxy:
    external: true

volumes:
  searxng-valkey-data:
